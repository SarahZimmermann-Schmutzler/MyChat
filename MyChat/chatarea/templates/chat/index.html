{% extends "base.html" %}
{% block content %}
<!-- wird bei bei base.html an entsprechender Stelle eingefügt -->
<!-- am Ende mit endblock geschlossen -->

<div id="messageContainer">
    {% for message in messages %}
    <div>
        <span class="color-grey">[{{message.created_at}}]</span> {{message.author}}: <i>{{message.text}}</i>
    </div>
    {% endfor %}
    <!-- alle Nachrichten des Chats mit der id=1 werden auf Seite angezeigt, inkl Erstellungsdatum und Autor -->
</div>

<script>
    // senden Daten an Backend und geben sie wieder aus
    async function sendMessage() {
        let formdata = new FormData();
        // brauchen formData, um Formular zu erstellen
        formdata.append('textmessage', messagefield.value);
        // let messagefield = document.getElementById('messagefield').value
        // nicht mehr notwendig, weil automatisch ausgeführt
        // append: name der Variable, die ans Backend gesendet werden soll und ihr Wert

        let token = '{{csrf_token}}'
        formdata.append('csrfmiddlewaretoken', token);
        // token muss mitgeschickt werden

        try {
            const wholeDate = new Date().toString();
            const date = wholeDate.slice(4, 15)
            messageContainer.innerHTML += `<div id='deleteMessage'><span class="color-grey">[${date}]</span> {{request.user}}: <i class="color-grey">${messagefield.value}</i></div>`;
            // Kopie der neuen Nachricht wird generiert in grau

            messagefield.value = '';

            let response = await fetch('', {
                method: 'POST',
                body: formdata
            });
            // POST Request als JSON = Daten (=neue Message) an Server/Backend gesendet

            let json = await response.json();
            let message_data = JSON.parse(json);
            // response wird umgewandelt, damit wir im Frontend damit arbeiten können
            // console.log('json is', json)
            // console.log('message data', message_data)

            document.getElementById('deleteMessage').remove();
            // grauer Platzhalter-Text wird wieder entfernt


            messageContainer.innerHTML += `<div><span class="color-grey">[${date}]</span> {{request.user}}: <i>${message_data['fields']['text']}</i></div>`;
            // jetzt zumindest beim Text Original Backend-Daten

            console.log('Success!')


        } catch (e) {
            console.error('An error occured', e)
        }
    }
</script>

<!-- Eingabe Textmessage -->
<form onsubmit="sendMessage(); return false;" method="post">
    {% csrf_token %}
    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
        <input class="mdl-textfield__input" name="textmessage" type="text" id="messagefield">
        <label class="mdl-textfield__label" for="messagefield">Text...</label>
    </div>

    <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
        Send
    </button>
</form>

<form action="/logout/" method="POST">
    {% csrf_token %}
    <button>Logout</button>
</form>

{% endblock %}